apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ .Values.argocd.appname }}
  namespace: {{ .Values.argocd.namespace }}
spec:
  syncPolicy:
    automated: {}
    syncOptions:
      - ApplyOutOfSyncOnly=true
      - CreateNamespace=true
  project: {{ .Values.project }}
  destination:
    server: {{ .Values.cluster.address }}
    namespace: {{ .Values.cluster.namespace }}
  sources:
  - repoURL: {{ .Values.values.repo_URL }}
    targetRevision: {{ .Values.values.branch }}
    ref: values
  - repoURL: 'https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts'
    targetRevision: 1.4.7
    chart: secrets-store-csi-driver
  - repoURL: {{ .Values.postgresql.repo_URL }}
    targetRevision: {{ .Values.postgresql.targetRevision }}
    chart: {{ .Values.postgresql.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.postgresql.valueFiles }}
        - $values/app-values/Postgresql/{{ . }}
        {{- end }}
      values: |
        fullnameOverride: {{ .Values.postgresql.nameOverride }}
        {{- if .Values.postgresql.primary }}
        primary: {{- toYaml .Values.postgresql.primary | nindent 10 }}
        {{- end }}
  - repoURL: {{ .Values.keycloak.repo_URL }}
    targetRevision: {{ .Values.keycloak.targetRevision }}
    chart: {{ .Values.keycloak.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.keycloak.valueFiles }}
        - $values/app-values/Keycloak/{{ . }}
        {{- end }}
      values: |
        fullnameOverride: {{ .Values.keycloak.nameOverride }}
        apiUrl: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
        externalDatabase:
          host: "postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local"
        extraEnvVars:
        - name: KC_HOSTNAME_ADMIN
          value: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/auth"
        - name: KC_HOSTNAME
          value: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/auth"
        - name: USERS_ROLES_BASE_URL
          value: "http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080"
        - name: KEYCLOAK_BASE_URL
          value: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/auth"
        - name: REALM
          value: "participant"
        - name: KEYCLOAK_EXTRA_ARGS
          value: --import-realm
        {{- if .Values.keycloak.resourcesPreset }}
        resourcesPreset: {{ .Values.keycloak.resourcesPreset }}
        {{- end }}
        {{- if .Values.keycloak.resources }}
        resources: {{- toYaml .Values.keycloak.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.sdtooling_api_be.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.sdtooling_api_be.targetRevision }}
    chart: {{ .Values.sdtooling_api_be.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.sdtooling_api_be.valueFiles }}
        - $values/app-values/sdtooling-api-be/{{ . }}
        {{- end }}
      values: |
        domain: {{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        vaultEnvIdentifier: {{ .Values.secretEngine }}
        domainUrlEnvIdentifier: {{ .Values.namespaceEnvironment }}
        validation:
          config:
            domain: http://sd-creation-wizard-api-validation.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        edcConnector:
          baseUrl: https://edc.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
          tier2BaseUrl: https://tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/edc
          participantId: {{ .Values.domainPrefix }}
        usersRoles:
          apiUrl: http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        authenticationProvider:
          apiUrl: http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        federatedCatalogue:
          tier2Gateway:
            uri: "https://tls.{{ .Values.authority.baseUrl }}"
            pathPrefix: /fc
        participant:
          onboarding:
            authorityTLSUri: "https://tls.{{ .Values.authority.baseUrl }}"
      releaseName: {{ .Values.sdtooling_api_be.nameOverride }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.sdtooling_validation_api_be.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.sdtooling_validation_api_be.targetRevision }}
    chart: {{ .Values.sdtooling_validation_api_be.chart_name }}
    helm:
      values: |
        domain: {{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        domainUrlEnvIdentifier: {{ .Values.namespaceEnvironment }}
        vaultEnvIdentifier: {{ .Values.secretEngine }}
      valueFiles:
        {{- range .Values.sdtooling_validation_api_be.valueFiles }}
        - $values/app-values/sdtooling-validation-api-be/{{ . }}
        {{- end }}
      releaseName: {{ .Values.sdtooling_validation_api_be.nameOverride }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.xsfc_advsearch_be.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.xsfc_advsearch_be.targetRevision }}
    chart: {{ .Values.xsfc_advsearch_be.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.xsfc_advsearch_be.valueFiles }}
        - $values/app-values/xsfc-advsearch-be/{{ . }}
        {{- end }}
      values: |
        domain: {{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        usersRoles:
          apiUrl: http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        authenticationProvider:
          apiUrl: http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        catalogueAdapter:
          tier2Gateway:
            uri: "https://tls.{{ .Values.authority.baseUrl }}"
            pathPrefix: /adapter
        federatedCatalogue:
          tier2Gateway:
            uri: "https://tls.{{ .Values.authority.baseUrl }}"
            pathPrefix: /fc
        participant:
          onboarding:
            authorityTLSUri: "https://tls.{{ .Values.authority.baseUrl }}"
      releaseName: {{ .Values.xsfc_advsearch_be.nameOverride }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.signer.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.signer.targetRevision }}
    chart: {{ .Values.signer.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.signer.valueFiles }}
        - $values/app-values/Signer/{{ . }}
        {{- end }}
      values: |
        serviceAccount:
          name: "{{ .Values.signer.serviceAccountName }}"
        ingress:
          frontendDomain: signer.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        secretEngine: {{ .Values.secretEngine }}
        hashicorp:
          service: {{ .Values.hashicorp.service }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.simpl_catalogue_client.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.simpl_catalogue_client.targetRevision }}
    chart: {{ .Values.simpl_catalogue_client.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.simpl_catalogue_client.valueFiles }}
        - $values/app-values/Simpl-catalogue-client/{{ . }}
        {{- end }}
      values: |
        env:
          PUBLIC_AUTH_KEYCLOAK_SERVER_URL: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
          PUBLIC_AUTH_KEYCLOAK_REALM: "participant"
          PUBLIC_AUTH_KEYCLOAK_CLIENT_ID: "frontend-cli"
          PUBLIC_FC_DATA_URL: "https://tls.{{ .Values.authority.baseUrl }}/fc"
          PUBLIC_SEARCH_API_URL: "http://xsfc-advsearch-be.{{ .Values.cluster.namespace }}.svc.cluster.local:8080"
          PUBLIC_AGENT_TYPE: "provider"
        ingress:
          hosts:
            - host: catalogue-ui.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
              paths:
              - path: /
                pathType: ImplementationSpecific
          tls:
            - secretName: catalogue-ui-tld-secret
              hosts:
                - catalogue-ui.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        {{- if .Values.simpl_catalogue_client.resources }}
        resources: {{- toYaml .Values.simpl_catalogue_client.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.simpl_cloud_gateway.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.simpl_cloud_gateway.targetRevision }}
    chart: {{ .Values.simpl_cloud_gateway.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.simpl_cloud_gateway.valueFiles }}
        - $values/app-values/Simpl-Cloud-Gateway/{{ . }}
        {{- end }}
      values: |
        global:
          hostBe: be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
          hostTls: tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
          authorityUrl: https://be.{{ .Values.authority.baseUrl }}
          cors:
            allowOrigin: https://fe.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }},http://localhost:4202,http://localhost:3000
        keycloakUrl: http://keycloak.{{ .Values.cluster.namespace }}.svc.cluster.local
        usersRolesUrl: http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        authenticationProviderUrl: http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        appConfig:
          spring:
            cloud:
              gateway:
                routes:
                  - id: keycloak
                    uri: ${keycloak.url}
                    predicates:
                      - Path=/auth/**
                    filters:
                      - StripPrefix=1
                  - id: users-roles
                    uri: ${users-roles.url}
                    predicates:
                      - Path=/user-api/**
                    filters:
                      - StripPrefix=1
                  - id: authentication-provider
                    uri: ${authentication-provider.url}
                    predicates:
                      - Path=/auth-api/**
                    filters:
                      - StripPrefix=1
                  - id: contract-consumption-be
                    uri: http://simpl-contract.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
                    predicates:
                      - Path=/simpl-contract/**
                    filters:
                      - StripPrefix=1
                  - id: sdtooling-wizard-be
                    uri: http://sd-creation-wizard-api.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
                    predicates:
                      - Path=/sdtooling-api/**
                    filters:
                      - StripPrefix=1
                  - id: xsfc-advsearch-be
                    uri: http://xsfc-advsearch-be.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
                    predicates:
                      - Path=/xsfc-advsearch-be/**
                    filters:
                      - StripPrefix=1
                  - id: signer-service
                    uri: http://signer.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
                    predicates:
                      - Path=/signer/**
                    filters:
                      - StripPrefix=1
        {{- if .Values.simpl_cloud_gateway.resources }}
        resources: {{- toYaml .Values.simpl_cloud_gateway.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.users_roles.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.users_roles.targetRevision }}
    chart: {{ .Values.users_roles.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.users_roles.valueFiles }}
        - $values/app-values/Users-Roles/{{ . }}
        {{- end }}
      values: |
        global:
          hostBe: be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
          hostTls: tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        db:
          url: "jdbc:postgresql://postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local:5432/usersroles"
        redis:
          host: "redis-master.{{ .Values.cluster.namespace }}.svc.cluster.local"
        microservices:
          authenticationProviderUrl: http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        {{- if .Values.users_roles.resources }}
        resources: {{- toYaml .Values.users_roles.resources | nindent 10 }}
        {{- end }}
  - repoURL: {{ .Values.redis.repo_URL }}
    targetRevision: {{ .Values.redis.targetRevision }}
    chart: {{ .Values.redis.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.redis.valueFiles }}
        - $values/app-values/Redis/{{ . }}
        {{- end }}
      values: |
        fullnameOverride: {{ .Values.redis.nameOverride }}
        {{- if .Values.redis.master }}
        master: {{- toYaml .Values.redis.master | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.simpl_fe.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.simpl_fe.targetRevision }}
    chart: {{ .Values.simpl_fe.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.simpl_fe.valueFiles }}
        - $values/app-values/Simpl-fe/{{ . }}
        {{- end }}
      values: |
        hostFe: fe.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        hostBe: be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        cors:
          allowOrigin: https://fe.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }},https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }},http://localhost:4202,http://localhost:4203,http://localhost:3000
        env:
        - name: API_URL
          value: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
        - name: KEYCLOAK_URL
          value: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/auth"
        - name: KEYCLOAK_REALM
          value: "participant"
        - name: KEYCLOAK_CLIENT_ID
          value: "frontend-cli"
        {{- if .Values.simpl_fe.resources }}
        resources: {{- toYaml .Values.simpl_fe.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.tls_gateway.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.tls_gateway.targetRevision }}
    chart: {{ .Values.tls_gateway.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.tls_gateway.valueFiles }}
        - $values/app-values/tls-gateway/{{ . }}
        {{- end }}
      values: |
        global:
          cors:
            allowOrigin: https://fe.{{ .Values.authority.baseUrl }},https://be.{{ .Values.authority.baseUrl }},http://localhost:4202,http://localhost:3000
        microservices:
          usersRolesUrl: http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
          keycloakUrl: http://keycloak.{{ .Values.cluster.namespace }}.svc.cluster.local
          authenticationProviderUrl: http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        redis:
          host: "redis-master.{{ .Release.Namespace }}.svc.cluster.local"
        hostT2: "tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
        authorityUrlT1: "https://be.{{ .Values.authority.baseUrl }}"
        {{- if .Values.tls_gateway.resources }}
        resources: {{- toYaml .Values.tls_gateway.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.auth_provider.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.auth_provider.targetRevision }}
    chart: {{ .Values.auth_provider.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.auth_provider.valueFiles }}
        - $values/app-values/auth-provider/{{ . }}
        {{- end }}
      values: |
        db:
          url: "jdbc:postgresql://postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local:5432/authenticationprovider"
        microservices:
          usersRolesUrl: http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080
        simpl:
          certificate:
            san: "tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
        {{- if .Values.auth_provider.resources }}
        resources: {{- toYaml .Values.auth_provider.resources | nindent 10 }}
        {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.simpl_edc.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.simpl_edc.targetRevision }}
    chart: {{ .Values.simpl_edc.chart_name }}
    helm:
      releaseName: {{ .Values.simpl_edc.nameOverride }}
      valueFiles:
        {{- range .Values.simpl_edc.valueFiles }}
        - $values/app-values/simpl-edc/{{ . }}
        {{- end }}
      values: |
        deployment:
          # image: "code.europa.eu:4567/simpl/simpl-open/development/gaia-x-edc/simpl-edc"
          # tag: "0.0.7-F-feature-simpl-8656-upgrade-aruba-lib.latest"
          callbackAddress: https://tls.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/edc
          label: edc
          vault:
            url: {{ .Values.hashicorp.service }}
            secretPath: /v1/edc
            timeout: 30
        ingress:
          enabled: false
          protocolPath: /protocol
        env:
          edcParticipantId: "{{ .Values.domainPrefix }}"
          edcIdsId: "urn:connector:{{ .Values.domainPrefix }}"
        # this might not be needed as it's moved to vault but test like this for now
        postgresql:
          url: "jdbc:postgresql://postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local:5432/edc"
          policyUrl: "jdbc:postgresql://postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local:5432/edc"
          password: "edc"
        tls:
          url:
            authority: "https://tls.{{ .Values.authority.baseUrl }}"
            usersRoles: "http://users-roles.{{ .Values.cluster.namespace }}.svc.cluster.local:8080/credential/download"
            authenticationProvider: "http://authentication-provider.{{ .Values.cluster.namespace }}.svc.cluster.local:8080/keypair"
        contractmanager:
          extension:
            enabled: true
          apikey: test
          url: http://url:8080/contract/v1/
        {{- if .Values.simpl_edc.resources }}
        resources: {{- toYaml .Values.simpl_edc.resources | nindent 10 }}
        {{- end }}
  {{ if .Values.simpl_contract.enabled }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.simpl_contract.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.simpl_contract.targetRevision }}
    chart: {{ .Values.simpl_contract.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.simpl_contract.valueFiles }}
        - $values/app-values/simpl-contract/{{ . }}
        {{- end }}
      values: |
        deployment:
          mode: PROVIDER
          kafka:
            bootstrapServer: http://kafka.{{ .Values.cluster.commonToolsNamespace }}.svc.cluster.local:9092
            clientUser: user1
            securityProtocol: SASL_PLAINTEXT
            sasl:
              mechanism: PLAIN
          urls:
            stubs: "http://simpl-stubs.{{ .Values.cluster.namespace }}.svc.cluster.local:8080"
          db:
            url: "jdbc:postgresql://postgresql.{{ .Values.cluster.namespace }}.svc.cluster.local:5432/simpl_contract"
            user: "simpl_contract"
          vault:
            address: {{ .Values.hashicorp.service }}
            dbPasswordUrldbPasswordUrl: "kv/data/contract-billing/db-secrets"
            dbPasswordName: DB_PASSWORD
            apiKeyUrl: "kv/data/contract-billing/apikey-secrets"
            apiKeyName: API_KEY
            kafkaPasswordUrl: "kv/data/contract-billing/kafka-secrets"
            kafkaPasswordName: KAFKA_CLIENT_PASSWORD
            roleName: contract
          {{- if .Values.simpl_contract.resources }}
          resources: {{- toYaml .Values.simpl_contract.resources | nindent 10 }}
          {{- end }}        
  {{- end }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.sd_ui.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.sd_ui.targetRevision }}
    chart: {{ .Values.sd_ui.chart_name }}
    helm:
      valueFiles:
        {{- range .Values.sd_ui.valueFiles }}
        - $values/app-values/simpl-sd-ui/{{ . }}
        {{- end }}
      values: |
        ingress:
          hosts:
            - host: sd-ui.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
              paths:
              - path: /
                pathType: ImplementationSpecific
          tls:
            - secretName: sd-ui-tld-secret
              hosts:
                - sd-ui.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        env:
          PUBLIC_AUTH_KEYCLOAK_SERVER_URL: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}"
          PUBLIC_AUTH_KEYCLOAK_REALM: "participant"
          PUBLIC_AUTH_KEYCLOAK_CLIENT_ID: "frontend-cli"
          PUBLIC_CREATION_WIZARD_API_URL: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/sdtooling-api"
          PUBLIC_SIGNER_URL: "https://be.{{ .Values.domainPrefix }}.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}/signer"
  {{- if .Values.monitoring.enabled }}
  - repoURL: "https://code.europa.eu/api/v4/projects/{{ .Values.monitoring.projectID }}/packages/helm/stable"
    path: ''
    targetRevision: {{ .Values.monitoring.targetRevision }}
    chart: {{ .Values.monitoring.chart_name }}
    helm:
      releaseName: {{ .Values.monitoring.fullnameOverride }}
      valueFiles:
        {{- range .Values.monitoring.valueFiles }}
        - $values/app-values/monitoring/{{ . }}
        {{- end }}
      values: |
        domainSuffix: {{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}
        namespaceTag: {{ .Values.domainPrefix }}
        mainNamespace: {{ .Values.cluster.commonToolsNamespace }}
        metricbeat:
          kubeStateHost: {{ .Values.cluster.kubeStateHost }}
        heartbeat:
          services:
            heartbeat.monitors:
            - type: tcp
              name: Elasticsearch Service
              id: elasticsearch:9200
              schedule: '@every 5s'
              hosts: ["elastic-elasticsearch-es-http.{{ .Values.cluster.namespace }}.svc:9200"]
            - type: tcp
              name: Kibana GUI
              id: kibana:443
              schedule: '@every 5s'
              hosts: ["kibana.{{ .Values.namespaceEnvironment }}.{{ .Values.domainSuffix }}.{{ .Values.domainSuffix }}:443"]
            - type: icmp
              id: kibana/icmp
              name: Kibana ICMP
              hosts: ["elastic-kibana-kb-http.{{ .Values.cluster.namespace }}.svc"]
              schedule: '*/5 * * * * * *'
  {{- end }}